<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TrakNor CMMS - Sistema de Gestão de Manutenção HVAC</title>
    
    <!-- GitHub Spark Integration Meta Tags -->
    <meta name="spark-preview" content="true" />
    <meta name="spark-codespace-port" content="5175" />
    <meta name="spark-communication" content="enabled" />
    
    <!-- CORS Configuration for GitHub Spark -->
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <meta http-equiv="Access-Control-Allow-Methods" content="GET, POST, PUT, DELETE, OPTIONS" />
    <meta http-equiv="Access-Control-Allow-Headers" content="Origin, X-Requested-With, Content-Type, Accept, Authorization, X-Spark-Preview" />
    
    <!-- Content Security Policy para GitHub Spark -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:* ws://localhost:* https://github.com https://*.github.com; 
                   connect-src 'self' http://localhost:* ws://localhost:* https://github.com https://*.github.com; 
                   img-src 'self' data: https:; 
                   style-src 'self' 'unsafe-inline';">
    
    <!-- Bloquear requisições específicas -->
    <meta name="blocked-domains" content="redesigned-system-*,*-4000.app.github.dev,*.tunnels.api.visualstudio.com">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter&family+Noto+Serif&display=swap">
    
    <!-- GitHub Spark Communication Script -->
    <script>
    <!-- CRITICAL: GitHub Spark Aggressive Interception -->
    <script>
        // Interceptação ULTRA AGRESSIVA - Executar IMEDIATAMENTE
        (function() {
            'use strict';
            
            console.log('[SPARK INTERCEPT] Ultra aggressive mode activated');
            
            // Salvar original
            const _fetch = window.fetch;
            const _XHR = window.XMLHttpRequest;
            const _WS = window.WebSocket;
            
            // Lista de padrões bloqueados
            const BLOCKED = [
                'redesigned-system-',
                '-4000.app.github.dev',
                'css/theme',
                'tunnels.api.visualstudio.com',
                'spark-preview--',
                'kind-fog-'
            ];
            
            // Override fetch AGRESSIVAMENTE
            Object.defineProperty(window, 'fetch', {
                configurable: false,
                enumerable: true,
                writable: false,
                value: function(input, init) {
                    const url = (input && typeof input === 'object' && 'url' in input) 
                        ? input.url 
                        : String(input);
                    
                    // Verificar bloqueio
                    if (BLOCKED.some(pattern => url.includes(pattern))) {
                        console.log('[SPARK INTERCEPT] FETCH BLOCKED:', url);
                        
                        // Mock para CSS
                        if (url.includes('css/theme')) {
                            return Promise.resolve(new Response('/* Spark Theme CSS */', {
                                status: 200,
                                headers: {
                                    'Content-Type': 'text/css',
                                    'Access-Control-Allow-Origin': '*'
                                }
                            }));
                        }
                        
                        // Mock genérico
                        return Promise.resolve(new Response('{"blocked":true}', {
                            status: 200,
                            headers: {
                                'Content-Type': 'application/json',
                                'Access-Control-Allow-Origin': '*'
                            }
                        }));
                    }
                    
                    return _fetch.apply(window, arguments);
                }
            });
            
            // Override XMLHttpRequest
            window.XMLHttpRequest = function() {
                const xhr = new _XHR();
                const _open = xhr.open;
                
                xhr.open = function(method, url) {
                    if (BLOCKED.some(pattern => String(url).includes(pattern))) {
                        console.log('[SPARK INTERCEPT] XHR BLOCKED:', url);
                        url = 'data:application/json,{"blocked":true}';
                    }
                    return _open.apply(xhr, arguments);
                };
                
                return xhr;
            };
            
            // Override WebSocket
            window.WebSocket = function(url) {
                if (BLOCKED.some(pattern => url.includes(pattern))) {
                    console.log('[SPARK INTERCEPT] WEBSOCKET BLOCKED:', url);
                    // Retornar fake WebSocket
                    return {
                        CONNECTING: 0, OPEN: 1, CLOSING: 2, CLOSED: 3,
                        readyState: 3,
                        send: () => {},
                        close: () => {},
                        addEventListener: () => {},
                        removeEventListener: () => {},
                        dispatchEvent: () => false
                    };
                }
                return new _WS(url);
            };
            
            // Prevenir modificação
            Object.freeze(window.fetch);
            Object.freeze(window.XMLHttpRequest);
            Object.freeze(window.WebSocket);
            
            console.log('[SPARK INTERCEPT] Protection activated and frozen');
        })();
        
        // Comunicação com GitHub Spark
        window.addEventListener('load', () => {
            if (window.parent !== window) {
                window.parent.postMessage({ 
                    type: 'spark-app-loaded',
                    port: 5175,
                    status: 'ready',
                    corsFixed: true,
                    interceptActive: true
                }, '*');
            }
        });
    </script>
</head>

<body>
    <div id="root"></div>
    
    <!-- Registrar Service Worker para interceptação adicional -->
    <script>
        // Registrar Service Worker para interceptação adicional
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/spark-intercept-sw.js')
                .then(() => console.log('[SW] Spark intercept registered'))
                .catch(err => console.log('[SW] Registration failed:', err));
        }
    </script>
    
    <script type="module" src="/src/main.tsx"></script>
</body>

</html>
